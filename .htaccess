# Включение механизма перезаписи
RewriteEngine On

# Перенаправление для React Router - все запросы, кроме api/ и файлов, идут на index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^ index.html [L]

# Настройки CORS
<IfModule mod_headers.c>
    # Разрешаем запросы с нашего домена и поддомена www
    SetEnvIf Origin "^(https?://(www\.)?xn----9sb8ajp\.xn--p1ai)$" allowed_origin=$0
    Header always set Access-Control-Allow-Origin "%{allowed_origin}e" env=allowed_origin
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range"
    Header always set Access-Control-Allow-Credentials "true"
    
    # Для preflight запросов
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# Правильное обслуживание статических файлов
<FilesMatch "\.(webmanifest|svg|png|jpg|jpeg|gif|ico|webp|js|css)$">
    Header set Cache-Control "max-age=2592000, public"
</FilesMatch>

# Правильное обслуживание .webmanifest файлов
<Files "site.webmanifest">
    ForceType application/manifest+json
    Header set Content-Type application/manifest+json
</Files>

# Правильное обслуживание SVG файлов
<Files "*.svg">
    ForceType image/svg+xml
    Header set Content-Type image/svg+xml
</Files>

# Запретить доступ к .env файлам
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

# Запретить доступ к composer файлам
<Files "composer.*">
    Order allow,deny
    Deny from all
</Files>

# Запретить доступ к служебным файлам
<FilesMatch "^(\.htaccess|\.gitignore|\.env\.example|README\.md|package\.json|package-lock\.json)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Запретить листинг директорий
Options -Indexes

# Устанавливаем кодировку по умолчанию
AddDefaultCharset UTF-8

# Настройки кэширования для статических файлов
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# Сжатие файлов
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>